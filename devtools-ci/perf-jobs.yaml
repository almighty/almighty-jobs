- job:
    name: 'devtools-test-performance-core-db'
    defaults: global
    node: devtools
    properties:
        - github:
            url: https://github.com/aslakknutsen/almighty-performance
    scm:
        - git:
            url: https://github.com/aslakknutsen/almighty-performance.git
            shallow_clone: true
            branches:
                - master
    triggers:
        - timed: '15 00 * * *'
    builders:
        - shell: |
            set +e
            set +x
            oc set env dc almighty-performance RATE=120 DURATION=30s
            sleep 10
            oc scale --replicas=1 dc almighty-performance
            sleep 10
            oc scale --replicas=0 dc almighty-performance
            oc logs dc/almighty-performance --follow

- job:
    name: 'devtools-test-perfcake-performance-core-db'
    defaults: global
    node: devtools
    properties:
        - github:
            url: https://github.com/ldimaggi/perfcake
    scm:
        - git:
            url: https://github.com/ldimaggi/perfcake.git
            shallow_clone: true
            branches:
                - master
    triggers:
        - timed: '30 08,12 * * *'
    builders:
        - shell: |
            set +e
            set +x
            env > jenkins-env
            cat $creds_config_file >> jenkins-env
            export CICO_API_KEY=$(cat ~/duffy.key )
            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 5 ]; then
                    # give up after 5 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/5)"
                n=$[$n+1]
                sleep 60
            done
            echo 'Using Host' $CICO_hostname
            set -x
            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"
            $ssh_cmd yum -y install rsync
            rsync -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload
            $ssh_cmd -t "cd payload && /bin/bash ./POC_perf_test.sh"
            rtn_code=$?
            cico node done $CICO_ssid
            exit $rtn_code
    publishers:
        - archive:
            artifacts: ./perfcake-7.4/perfcake-chart
